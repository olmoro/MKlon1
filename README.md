# <p align="center">MKlon1
# <p align="center">Вариант ЗУ с блоком управления на ESP32
## <p align="center">Модульное зарядное устройство на ESP-WROOM-32D - проект Arduino.
#### <p align="right">редакция от 25 декабря 2022 года

![](https://github.com/olmoro/MKlon1/blob/main/MKlon/%D0%98%D0%B7%D0%BE%D0%B1%D1%80%D0%B0%D0%B6%D0%B5%D0%BD%D0%B8%D1%8F/MKlon1full.png?raw=true)

### MKlon1 - это вариант ЗУ, в котором блок управления и силовой  блок выполнены на отдельных платах. Что это дает?

Во-первых блок управления - весьма универсальное устройство, применение которого не ограничивается зарядным устройством, чего не скажешь о силовом блоке, тем более, что силовой блок может "масштабироваться" - сегодня достаточно 6 ампер, а завтра ...

Во-вторых платы имеют максимальный размер не более 99,9 мм, что позволяет заказывать их на [JLCPCB](https://jlcpcb.com/) по символической цене.

И, наконец, в случае неприятностей с силовым блоком более дорогой блок управления пострадает в меньшей степени.

### <p align="center">Особенности реализации блока управления.

1. Модульность
  - Модуль [ESP32-DevKitC V4](https://aliexpress.ru/item/4000090521976.html?sku_id=12000029209753874&spm=a2g2w.productlist.search_results.11.73194aa62fyZl2). Можно, конечно, ограничиться другими версиями ESP32-DevKit с уже распаянным ESP-WROOM-32D, но перспективнее будет запаять ESP32 с 16МБ памяти самостоятельно вместо обычных 4МБ.
  - Модуль [SAMD21 M0-Mini](https://aliexpress.ru/item/4000169610268.html?sku_id=10000014439572098&spm=a2g2w.productlist.search_results.0.3e1d4aa6X9e9wa). 
  - [Модуль прецизионных часов DS3231 IIC](https://aliexpress.ru/item/32822420722.html?sku_id=10000000337849443&spm=a2g2w.productlist.search_results.0.282f4aa6NF9AEI). Опциональная позиция.
  - [Понижающий модуль LM2596](https://aliexpress.ru/item/32464248769.html?sku_id=66628643348&spm=a2g2w.productlist.search_results.0.24134aa6Yv9n3p).
  - [Полноцветный ЖК-дисплей 1,8 дюйма 1,8x128 SPI TFT 160*128, модуль ST7735S](https://aliexpress.ru/item/1005003768467259.html?sku_id=12000027098966793&spm=a2g2w.productlist.search_results.0.4e024aa67UD2Mu)
  - Или [ЖК-модуль HD 3,5 дюйма SPI, 480*320, TFT-модуль ILI9486 ILI9488, сенсорная панель, 65K цветов](https://sl.aliexpress.ru/p?key=ypWZtdN).  

2. Разъемы для установки модулей рекомендую не ставить те, что идут в комплекте, а использовать цанговые [разъемы](https://www.chipdip.ru/product0/8002610753), где это возможно.

3. Подключение модуля дисплея. Посадочное место на плате имеет два ряда по 8 контактов. Можно установить 8-контактный разъем для 1,8 дюймового дисплея или 14-контактный для 3,5-дюймового. В этом случае не устанавливаются RGB-светодиод и зуммер, так как портов ESP32 как бы много их не казалось, на всё не хватает.

4. Выходное напряжение модуля питания следует установить на 5,5 вольта. Потенциометр желательно заменить на подобранный резистор от греха подальше.

5. Два узла схемы нуждаются в гальванически развязанных [источниках питания](https://aliexpress.ru/item/1005003568781579.html?_ga=2.165478714.428003227.1651560775-769654542.1642920280&sku_id=12000026320337806&spm=a2g39.orderlist.0.0.50684aa6oqK3eu) на 5 и 12 вольт мощностью 1 ватт.

5. Токовые шунты могут устанавливаться как проволочные, так и металлопленочные SMD из расчета падения напряжения на шунте не более 200 милливольт при максимальном токе разряда (да и заряда тоже).

6. Разъемы диагностики сигналов интерфейсов UART, SPI, IIC выведены на боковую сторону (если смотреть со стороны дисплея) двумя разъемами для подключения [логического анализатора](https://aliexpress.ru/item/1005004783286574.html?sku_id=12000030470334955&spm=a2g2w.productlist.list.6.4d1b5c5e8YmNAb).

7. Клавиатура пятикнопочная, подключается на разъем[6pin](https://aliexpress.ru/item/1005001530994945.html?sku_id=12000016489844779&spm=a2g2w.productlist.search_results.136.3ed74aa65LkFgb). Резистивный делитель обеспечивает оптимальное напряжение на аналоговом входе микроконтроллера при нажатии одной кнопки.

8. Четырехточечное подключение к аккумуляторной батарее позволяет измерять напряжение на клеммах от -2 до 20 вольт и ток обоих направлений на одном шунте по дифференциальной схеме. Не любые ["крокодилы"](https://aliexpress.ru/item/4000593884517.html?spm=a2g2w.orderdetails.0.0.777a4aa6ri0LqM&sku_id=12000020938249496&_ga=2.53804840.1610960066.1667852261-603987165.1661065985) подойдут для этой цели, а только такие, с изолированными друг от друга "щечками". Для силовых проводов подойдет [12AWG](https://aliexpress.ru/item/32760772505.html?sku_id=62000371951&spm=a2g2w.productlist.search_results.11.77224aa6MRNqge), для сигнальных - [26AWG](https://aliexpress.ru/item/32822800017.html?sku_id=64895845288&spm=a2g2w.productlist.search_results.11.dbb84aa6zxesXr), скрепленных попарно термоусадкой c разумной дистанцией.

9. Охлаждение [радиатора](https://aliexpress.ru/item/1005003036398261.html?spm=a2g2w.orderdetail.0.0.40064aa6mAj5TE&sku_id=12000030482618475производится) 12-вольтовым вентилятором, напряжение должно регулироваться ШИМ. 

10. Мониторинг питания в пределах +20 вольт имеется.

11. Интерфейсы USB обоих процессорных модулей доступны без отключения модулей от несущей платы. Следует учесть, что у них разные "земли", и одновременное подключение к компьютеру не желательно, однако и не приводит к каким-либо печальным последствиям, разве что немного "уплывают" калибровки".

12. Кнопка сброса подключена к обоим процессорным модулям.

13. Код предлагается портировать из проектов MKlon2 и MDrv2 самостоятельно.

14. И, наконец, видео без звука и титров [95M](https://github.com/olmoro/MKlon1/blob/main/MKlon/%D0%92%D0%B8%D0%B4%D0%B5%D0%BE/MKlon1.mp4).

